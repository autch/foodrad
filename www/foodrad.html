<!DOCTYPE html> 
<html> 
  <head> 
    <title>食品の放射能データ検索もどき（実験）</title> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1"> 
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.1.0-rc.1/jquery.mobile-1.1.0-rc.1.min.css" />
    <script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.1.0-rc.1/jquery.mobile-1.1.0-rc.1.min.js"></script>
    <script type="text/javascript">
// 使わせたい CSV ファイルへのパス。ファイルさえアクセス出来ればあとは YQL がやる
var use_this_csv = "http://tnok.jp/a358-a359.csv";

// { カテゴリ: [品名, 品名, ...] }
var categories = {
};
var load_ok = [];

function check_done_loading(sym) {
    load_ok.push(sym);

    if(load_ok.length >= 2) {
	jQuery.mobile.hidePageLoadingMsg();
	jQuery('#submit').removeProp("disabled");
    }
}

var YQL = {
    yql_url: 'http://query.yahooapis.com/v1/public/yql?callback=?',
    
    query: function(query, on_ready) {
        jQuery.getJSON(this.yql_url, {
            q: query,
            format: "json",
        }, function(data) {
	    if(parseInt(data.query.count) == 1) {
		data.query.results.row = [data.query.results.row];
	    }
            on_ready(data.query.results);
        });
    }
}

function get_area() {
    var query = 'SELECT col3 FROM csv WHERE url = "%s" ' +
        'AND charset="UTF-8" | SORT(field="col3") | UNIQUE(field="col3", hideRepeatCount="true")';
    var query_to_use = query.replace(/%s/, use_this_csv);

    YQL.query(query_to_use, function(results) {
	var sel = jQuery('#select-area');
	sel.empty();
	sel.append(jQuery("<option>").text("すべて").val(""));
	for(var i = 0; i < results.row.length; i++) {
	    var item = results.row[i];

	    if(/産地_都道府県/.test(item['col3']))
		continue;

	    var opt = jQuery("<option>");
	    opt.text(item['col3']).val(item['col3']);
	    sel.append(opt);
	}
	sel.trigger("create");
	check_done_loading("area");
    });
}

function get_categories() {
    var query = 'SELECT col7, col8 FROM csv WHERE url = "%s" ' +
                    'AND charset="UTF-8" | SORT(field="col7",field="col8") | UNIQUE(field="col8", hideRepeatCount="true")'
    var query_to_use = query.replace(/%s/, use_this_csv);

    YQL.query(query_to_use, function(results) {
	categories = {};
	for(var i = 0; i < results.row.length; i++) {
	    var item = results.row[i];

	    if(/食品カテゴリ/.test(item['col7']))
		continue;

	    if(categories[item['col7']]) {
		categories[item['col7']].push(item['col8']);
	    } else {
		categories[item['col7']] = [item['col8']];
	    }
	}
	var sel = jQuery('#select-category');
	sel.empty();
	sel.append(jQuery("<option>").text("すべて").val(""));
	for(var key in categories) {
	    var item = categories[key];
	    var opt = jQuery("<option>");
	    
	    opt.text(key).val(key);
	    
	    sel.append(opt);
	}
	sel.trigger("create");
	check_done_loading("category");
    });
}

function onchange_category(cat_name) {
    jQuery('#category').val(cat_name);

    var sel = jQuery('#select-name');
    var cat = categories[cat_name];

    sel.empty();
    sel.append(jQuery("<option>").text("すべて").val(""));
    for(var i = 0; i < cat.length; i++) {
	var opt = jQuery("<option>");
	
	opt.text(cat[i]).val(cat[i]);
	sel.append(opt);
    }
    sel.trigger("create");
}

function on_submit() {
    var query = 'SELECT * FROM csv WHERE url = "%URL%" AND charset="UTF-8" ' +
	'AND columns="no,reporter,performer,area,city,addr,sold,category,name,name_minor,examiner,method,on_sample,on_result,cs134,cs137,cs_total" ';
    var query_to_use = query.replace(/%URL%/, use_this_csv);
    
    var ul = jQuery("#result");
    ul.empty();

    jQuery.mobile.showPageLoadingMsg();

    if(jQuery('#area').val()) {
	query_to_use += 'AND area LIKE "%' + jQuery('#area').val() + '%" ';
    }
    if(jQuery('#category').val()) {
	query_to_use += 'AND category LIKE "%' + jQuery('#category').val() + '%" ';
    }
    if(jQuery('#name').val()) {
	query_to_use += 'AND name LIKE "%' + jQuery('#name').val() + '%" ';
    }
    var cs = jQuery('#Cs').val();
    if(parseInt(cs) > 0) {
	query_to_use += 'AND cs_total NOT LIKE "<%" AND cs_total >= ' + parseInt(cs);
    }

    YQL.query(query_to_use, function(results) {
	var ul = jQuery("#result");
	ul.empty();

	if(results == null || results.row == null) {
	    jQuery("<li>").text("見つかりませんでした").appendTo(ul);
	    jQuery('ul.dynamic-list').listview('refresh');
	    jQuery.mobile.hidePageLoadingMsg();
	    return;
	}

	for(var i = 0; i < results.row.length; i++) {
	    var item = results.row[i];

	    if(/食品カテゴリ/.test(item['category']))
		continue;
	    
	    var li = jQuery("<li>");
	    var anchor = jQuery("<a>");

	    var title = jQuery("<h3>").text(item['name'] + " ").append(jQuery("<small>").text(item['category']));
	    var p1 = jQuery("<p>").text("Cs134: " + item['cs134'] + " Bq/kg"),
	    p2 = jQuery("<p>").text("Cs137: " + item['cs137'] + " Bq/kg");

	    anchor.append(title).append(p1).append(p2);

	    jQuery.data(anchor, "item", item);
	    
	    anchor.attr("href", "#detailPage").attr("data-rel", "dialog");
	    anchor.click(item, function(event) {
		showDetail(event);
	    });

	    li.append(anchor);
	    ul.append(li);
	}
	jQuery('ul.dynamic-list').listview('refresh');
	jQuery.mobile.hidePageLoadingMsg();
    });
}

function showDetail(event) {
    var data = event.data;
    for(var key in data) {
	var td = jQuery("#detail-" + key);
	if(td && td.length > 0) {
	    td.text(data[key]);
	}
    }
}

    </script>
  </head> 
  <body> 
    <div id="mainPage" data-role="page">
      <div data-role="header">
	<h1>食品の放射能データ検索もどき（実験）</h1>
      </div><!-- /header -->

      <div data-role="content">	

	<p>元ネタは <a href="http://oku.edu.mie-u.ac.jp/food/">食品の放射能データ検索もどき（実験）</a></p>
	<p><a href="http://oku.edu.mie-u.ac.jp/~okumura/stat/data/mhlw/">http://oku.edu.mie-u.ac.jp/~okumura/stat/data/mhlw/</a> から a357～a359.csv を結合したものを使っています。</p>
	<p>YQL で検索するので完全一致のみ。</p>

	  <fieldset>
	    <legend>検索条件</legend>
	    <div data-role="fieldcontain">
	      <label for="area" class="ui-hidden-accessible">都道府県</label>
              <input id="area" name="area" size="20" value="" placeholder="都道府県" />
	      <select name="select-area" id="select-area" onchange="$('#area').val($(this).val())">
		<option value="">すべて</option>
	      </select>
	    </div>
	    <div data-role="fieldcontain">
	      <label for="category" class="ui-hidden-accessible">食品カテゴリ</label>
              <input id="category" name="category" size="20" value="" placeholder="食品カテゴリ" />
	      <select name="select-category" id="select-category" onchange="onchange_category($(this).val())">
		<option value="">すべて</option>
	      </select>
	    </div>
	    <div data-role="fieldcontain">
	      <label for="name" class="ui-hidden-accessible">品目</label>
	      <input id="name" name="name" size="20" value="" placeholder="品目" />
	      <select name="select-name" id="select-name" onchange="$('#name').val($(this).val())">
		<option value="">すべて</option>
	      </select>
	    </div>
            <input type="hidden" id="I131" name="I131" value="0"/>
	    <div data-role="fieldcontain">
	      <label for="Cs">Cs-134+137 <input id="Cs" name="Cs" size="5" value="100" /> Bq/kg 以上</label>
	    </div>
	  </fieldset>
	  <a href="#resultPage" data-role="button" id="submit" onclick="on_submit()">検索</a>
	
      </div><!-- /content -->
    </div><!-- /page -->


    <div id="resultPage" data-role="page">
      <div data-role="header">
	<a href="#mainPage" data-icon="back" data-direction="reverse" class="ui-btn-left jqm-back">戻る</a>
	<h1>食品の放射能データ検索もどき（実験）</h1>
      </div><!-- /header -->

      <div data-role="content">	
	<ul data-role="listview" class="dynamic-list" id="result">
	</ul>
      </div>
    </div>

    <div id="detailPage" data-role="page">
      <div data-role="header">
	<!--a href="#resultPage" data-icon="back" data-direction="reverse" class="ui-btn-left jqm-back">戻る</a-->
	<h1>検索結果詳細</h1>
      </div><!-- /header -->

      <div data-role="content">
	<table>
	  <tr><th scope="row">No</th><td id="detail-no"></td></tr>
	  <tr><th scope="row">報告自治体</th><td id="detail-reporter"></td></tr>
	  <tr><th scope="row">実施主体</th><td id="detail-performer"></td></tr>
	  <tr><th scope="row">産地 都道府県</th><td id="detail-area"></td></tr>
	  <tr><th scope="row">産地 市町村</th><td id="detail-city"></td></tr>
	  <tr><th scope="row">非流通品/流通品</th><td id="detail-sold"></td></tr>
	  <tr><th scope="row">食品カテゴリ</th><td id="detail-category"></td></tr>
	  <tr><th scope="row">品目</th><td id="detail-name"></td></tr>
	  <tr><th scope="row">品目委細</th><td id="detail-name_minor"></td></tr>
	  <tr><th scope="row">検査機関</th><td id="detail-examiner"></td></tr>
	  <tr><th scope="row">検査法 [Ge/NaI]</th><td id="detail-method"></td><tr>
	  <tr><th scope="row">採取日/購入日</th><td id="detail-on_sample"></td></tr>
	  <tr><th scope="row">結果判明日</th><td id="detail-on_result"></td></tr>
	  <tr><th scope="row">Cs134 [Bq/kg]</th><td id="detail-cs134"></td></tr>
	  <tr><th scope="row">Cs137 [Bq/kg]</th><td id="detail-cs137"></td></tr>
	</table>
	<a href="#resultPage" data-role="button" data-rel="back">閉じる</a>
      </div>
    </div>
<script>
    jQuery(function() {
	jQuery.mobile.showPageLoadingMsg();
	jQuery('#submit').attr('disabled', "disabled");
    });

    jQuery(document).delegate('#mainPage', 'pageinit', function() {
	get_area();
	get_categories();
    });
</script>
  </body>
</html>
